---
title: "Targets documentation for TOPFUN project"
output: html_document
---

Initialize the list of targets.

```{r tar_setup}
knitr::opts_chunk$set(echo = TRUE)

require(targets)
require(here)
require(tarchetypes)
require(dplyr)


targets <- list()
```

## Compile targets documentation

This chunk renders the documented list of targets into html file and saves it to the `docs` folder. As the `docs` folder is meant to contain documents generated by the code, its content is git-ignored.

```{r tar_documentation}

targets$documentation <- list(
    
    # Register tar_plan.Rmd file as a target
    tar_target(
        tar_plan_file,
        here("tar_plan.Rmd"),
        format = "file"
        ),
    
    # Render tar_plan.Rmd into html
    tar_target(
        tar_documentation,
        rmarkdown::render(tar_plan_file,
                          output_file = here("docs", 
                                             "plan_documentation.html"))
        )
)

```

## Import of raw data 

Download raw data content to the `data_raw` directory from URL.

Load the data as a target to be used in the pipeline.

```{r data_import}

targets$data_import <- list(
    
    # Download CSF data
    
    # tar_cue(mode = "never") means the target runs only when the targets cache is empty
    # download_data() checks if file exists in the location and skips the download
    # if that is the case. This means that for a full refresh of the project,  
    # data should be manually removed from the raw_data folder and the target should be
    # invalidate with targets::tar_invalidate(data_csf_download)

    
    # Download CSF dataset
    tar_target(
        data_csf_download,
        download_data(
            url = "https://owncloud.cesnet.cz/index.php/s/HIm7FEYQIMfoBuu/download",
            data_file = here("data", 
                             "data_raw", 
                             "czech_science_foundation.tsv")
            ),
        format = "file",
        cue = tar_cue(mode = "never")
    ),
   

    # Read CSF data as an R object
    tar_target(
        data_csf,
        read_tsv(data_csf_download)
    ),
    
    # Download ANR dataset
    tar_target(
        data_anr_download,
        download_data(
            url = "https://www.data.gouv.fr/fr/datasets/r/e8a473a5-12e4-4ead-ad77-aee3bfad48fd",
            data_file = here("data", 
                             "data_raw", 
                             "agence_nationale_recherche.csv")
            ),
        format = "file",
        cue = tar_cue(mode = "never")
    ),
    
    # Read ANR data as an R object
    tar_target(
        data_anr,
        read_delim(data_anr_download,
                   delim = ";",
                   locale = locale("fr",
                                  decimal_mark = "."))
    ),

    # Make documentation for data
    # moving rendered document to `docs` folder
    # temporary hack until output path can be specified directly 
    # in `tar_render`
    tar_render(
        data_documentation,
        path = "Rmd/data_documentation.Rmd"),
    tar_target(
        data_documentation_move,
        file.rename(data_documentation[1],
                    here("docs", "data_documentation.html")
                    ),
        cue = tar_cue("always")
    )
    
)


```


# Languages overview

```{r lang}

targets$lang <- list(
    
    tar_target(anr_lang_desc,
               detect_lang(data = data_anr,
                           id = "code_du_projet",
                           col = "resume",
                           whitelist = c("fra", "eng"),
                           keep_all = FALSE
                           )
               ),
    
    tar_target(csf_lang_desc,
               detect_lang(data = data_csf,
                           id = "project_code",
                           col = "abstract",
                           whitelist = c("ces", "eng"),
                           keep_all = FALSE
                           )
    ),
    
    tar_target(data_anr_for_translation,
        data_anr %>% 
            filter(code_du_projet %in% 
                              (anr_lang_desc %>% 
                              filter(resume_lang == "fra") %>% 
                              pull(code_du_projet))
                          ) %>% 
            mutate(source_text = 
                       paste(titre,
                             resume, 
                             sep = ". "
                             )
                   ) %>% 
            select(code_du_projet,
                   source_text
                   )
               ),
    
    tar_target(data_anr_translated,
               run_cubbitt_api(
                   data_anr_for_translation %>% 
                       slice_head(n = 5),
                   col = "source_text",
                   new_col = "resume_tr"),
               cue = tar_cue("never")
               )
    
    
)

```

