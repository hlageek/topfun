---
title: "Process raw data"
subtitle: "`data_process` subproject."
html:
    code-fold: true
    number-sections: true
---


## Setup

### Set environment for subproject

```{r}
#| label: set_project
Sys.setenv(TAR_PROJECT = "data_process")
```

### Initialize `data_process` script

```{r}
#| label: setup
library(targets)
tar_unscript()
knitr::opts_chunk$set(tar_script = "_data_process.R", collapse = TRUE, comment = "#>")
```


### Define `data_process` globals

We first define some global options/functions common to all targets.

```{r}
#| engine: targets
#| label: globals
#| tar_globals: true

# read custom functions
lapply(list.files(here::here("R"), full.names = TRUE), source)
tar_option_set(packages = packages())
```

## Targets for `data_process`

First we register raw data files.
```{r}
#| engine: targets
#| label: register_data
list(
  tar_target(
    name = input_data_files,
    command = targets::tar_read(input_data_files, store = "_store/_data_input"),
    format = "file",
    cue = tar_cue("always")
  )
)
```

### ANR
```{r}
#| engine: targets
#| label: anr_data
list(
  tar_target(
    name = anr_data_raw_2010,
    command = readr::read_delim(
      input_data_files[grep("anr_2010.csv", input_data_files)],
      delim = ";",
      locale = locale("fr", decimal_mark = "."),
      show_col_types = FALSE
      ) |>
      janitor::clean_names() |>
      dplyr::mutate(source = "since2010"),
    format = "qs"
  ),
  tar_target(
    name = anr_data_raw_2009,
    command = readr::read_delim(
      input_data_files[grep("anr_2009.csv", input_data_files)],
      delim = ";",
      locale = locale("fr", decimal_mark = "."),
      show_col_types = FALSE
    ) |>
      janitor::clean_names() |>
      dplyr::mutate(source = "before2009"),
    format = "qs"
  ),
  tar_target(
    name = anr_data_raw,
    command = dplyr::bind_rows(
      anr_data_raw_2010,
      anr_data_raw_2009
    ),
    format = "qs"
  )

  #   ,
  # tar_target(
  #     name = eu_data_raw,
  #     command = purrr::map_df(eu_download_files, read.csv2) |>
  #               dplyr::as_tibble(),
  #     format = "qs"
  #   )
  #   ,
  # tar_target(
  #     name = snsf_data_raw,
  #     command = read.csv2(snsf_download_files)|>
  #               dplyr::as_tibble(),
  #     format = "qs"
  #   )
)
```

## Reset subproject
```{r}
#| label: unset_project
Sys.setenv(TAR_PROJECT = "main")
```